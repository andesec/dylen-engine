"""baseline

Revision ID: f22845381c3c
Revises:
Create Date: 2026-01-29 03:02:03.938013

"""

from __future__ import annotations

import uuid
from collections.abc import Sequence

import sqlalchemy as sa
from alembic import op
from sqlalchemy.dialects import postgresql
from sqlalchemy.dialects.postgresql import insert

# revision identifiers, used by Alembic.
revision: str = "f22845381c3c"
down_revision: str | Sequence[str] | None = None
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
  """Upgrade schema."""
  # ### commands auto generated by Alembic - please adjust! ###
  op.create_table(
    "dylen_jobs",
    sa.Column("job_id", sa.String(), nullable=False),
    sa.Column("request", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column("status", sa.String(), nullable=False),
    sa.Column("target_agent", sa.String(), nullable=True),
    sa.Column("phase", sa.String(), nullable=False),
    sa.Column("subphase", sa.String(), nullable=True),
    sa.Column("expected_sections", sa.Integer(), nullable=True),
    sa.Column("completed_sections", sa.Integer(), nullable=True),
    sa.Column("completed_section_indexes", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("current_section_index", sa.Integer(), nullable=True),
    sa.Column("current_section_status", sa.String(), nullable=True),
    sa.Column("current_section_retry_count", sa.Integer(), nullable=True),
    sa.Column("current_section_title", sa.String(), nullable=True),
    sa.Column("retry_count", sa.Integer(), nullable=True),
    sa.Column("max_retries", sa.Integer(), nullable=True),
    sa.Column("retry_sections", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("retry_agents", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("retry_parent_job_id", sa.String(), nullable=True),
    sa.Column("total_steps", sa.Integer(), nullable=True),
    sa.Column("completed_steps", sa.Integer(), nullable=True),
    sa.Column("progress", sa.Double(), nullable=True),
    sa.Column("logs", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column("result_json", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("artifacts", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("validation", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("cost", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("created_at", sa.String(), nullable=False),
    sa.Column("updated_at", sa.String(), nullable=False),
    sa.Column("completed_at", sa.String(), nullable=True),
    sa.Column("ttl", sa.Integer(), nullable=True),
    sa.Column("idempotency_key", sa.String(), nullable=True),
    sa.PrimaryKeyConstraint("job_id"),
  )
  op.create_index(op.f("ix_dylen_jobs_idempotency_key"), "dylen_jobs", ["idempotency_key"], unique=False)
  op.create_table(
    "dylen_lessons",
    sa.Column("lesson_id", sa.String(), nullable=False),
    sa.Column("topic", sa.String(), nullable=False),
    sa.Column("title", sa.String(), nullable=False),
    sa.Column("created_at", sa.String(), nullable=False),
    sa.Column("schema_version", sa.String(), nullable=False),
    sa.Column("prompt_version", sa.String(), nullable=False),
    sa.Column("provider_a", sa.String(), nullable=False),
    sa.Column("model_a", sa.String(), nullable=False),
    sa.Column("provider_b", sa.String(), nullable=False),
    sa.Column("model_b", sa.String(), nullable=False),
    sa.Column("lesson_json", sa.Text(), nullable=False),
    sa.Column("status", sa.String(), nullable=False),
    sa.Column("latency_ms", sa.Integer(), nullable=False),
    sa.Column("idempotency_key", sa.String(), nullable=True),
    sa.Column("tags", sa.ARRAY(sa.Text()), nullable=True),
    sa.PrimaryKeyConstraint("lesson_id"),
  )
  op.create_index(op.f("ix_dylen_lessons_idempotency_key"), "dylen_lessons", ["idempotency_key"], unique=False)
  op.create_table(
    "fenster_widgets",
    sa.Column("fenster_id", sa.Uuid(), nullable=False),
    sa.Column("type", sa.Enum("INLINE_BLOB", "CDN_URL", name="fensterwidgettype"), nullable=False),
    sa.Column("content", sa.LargeBinary(), nullable=True),
    sa.Column("url", sa.String(), nullable=True),
    sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.PrimaryKeyConstraint("fenster_id"),
  )
  op.create_table(
    "llm_call_audit",
    sa.Column("id", sa.String(), nullable=False),
    sa.Column("created_at", sa.DateTime(timezone=True), nullable=True),
    sa.Column("timestamp_request", sa.DateTime(timezone=True), nullable=False),
    sa.Column("timestamp_response", sa.DateTime(timezone=True), nullable=True),
    sa.Column("started_at", sa.DateTime(timezone=True), nullable=False),
    sa.Column("duration_ms", sa.Integer(), nullable=False),
    sa.Column("agent", sa.String(), nullable=False),
    sa.Column("provider", sa.String(), nullable=False),
    sa.Column("model", sa.String(), nullable=False),
    sa.Column("lesson_topic", sa.String(), nullable=True),
    sa.Column("request_payload", sa.Text(), nullable=False),
    sa.Column("response_payload", sa.Text(), nullable=True),
    sa.Column("prompt_tokens", sa.Integer(), nullable=True),
    sa.Column("completion_tokens", sa.Integer(), nullable=True),
    sa.Column("total_tokens", sa.Integer(), nullable=True),
    sa.Column("request_type", sa.String(), nullable=False),
    sa.Column("purpose", sa.String(), nullable=True),
    sa.Column("call_index", sa.String(), nullable=True),
    sa.Column("job_id", sa.String(), nullable=True),
    sa.Column("status", sa.String(), nullable=False),
    sa.Column("error_message", sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint("id"),
  )
  op.create_table(
    "organizations",
    sa.Column("id", sa.Uuid(), nullable=False),
    sa.Column("name", sa.String(), nullable=False),
    sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.PrimaryKeyConstraint("id"),
    sa.UniqueConstraint("name"),
  )
  op.create_table(
    "permissions",
    sa.Column("id", sa.Uuid(), nullable=False),
    sa.Column("slug", sa.String(), nullable=False),
    sa.Column("display_name", sa.String(), nullable=False),
    sa.Column("description", sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint("id"),
    sa.UniqueConstraint("slug"),
  )
  op.create_table(
    "roles",
    sa.Column("id", sa.Uuid(), nullable=False),
    sa.Column("name", sa.String(), nullable=False),
    sa.Column("level", sa.Enum("GLOBAL", "TENANT", name="role_level"), nullable=False),
    sa.Column("description", sa.Text(), nullable=True),
    sa.PrimaryKeyConstraint("id"),
    sa.UniqueConstraint("name"),
  )
  op.create_table(
    "subscription_tiers",
    sa.Column("id", sa.Integer(), autoincrement=True, nullable=False),
    sa.Column("name", sa.String(), nullable=False),
    sa.Column("max_file_upload_kb", sa.Integer(), nullable=True),
    sa.Column("highest_lesson_depth", sa.Enum("highlights", "detailed", "training", name="lesson_depth"), nullable=True),
    sa.Column("max_sections_per_lesson", sa.Integer(), nullable=True),
    sa.Column("file_upload_quota", sa.Integer(), nullable=True),
    sa.Column("image_upload_quota", sa.Integer(), nullable=True),
    sa.Column("gen_sections_quota", sa.Integer(), nullable=True),
    sa.Column("research_quota", sa.Integer(), nullable=True),
    sa.Column("coach_mode_enabled", sa.Boolean(), nullable=False),
    sa.Column("coach_voice_tier", sa.String(), nullable=True),
    sa.PrimaryKeyConstraint("id"),
    sa.UniqueConstraint("name"),
  )
  op.create_table(
    "role_permissions",
    sa.Column("role_id", sa.Uuid(), nullable=False),
    sa.Column("permission_id", sa.Uuid(), nullable=False),
    sa.ForeignKeyConstraint(["permission_id"], ["permissions.id"]),
    sa.ForeignKeyConstraint(["role_id"], ["roles.id"]),
    sa.PrimaryKeyConstraint("role_id", "permission_id"),
  )
  op.create_table(
    "users",
    sa.Column("id", sa.Uuid(), nullable=False),
    sa.Column("firebase_uid", sa.String(), nullable=False),
    sa.Column("email", sa.String(), nullable=False),
    sa.Column("full_name", sa.String(), nullable=True),
    sa.Column("provider", sa.String(), nullable=True),
    sa.Column("role_id", sa.Uuid(), nullable=False),
    sa.Column("org_id", sa.Uuid(), nullable=True),
    sa.Column("status", sa.Enum("PENDING", "APPROVED", "DISABLED", name="user_status"), nullable=False),
    sa.Column("auth_method", sa.Enum("GOOGLE_SSO", "NATIVE", name="auth_method"), nullable=False),
    sa.Column("profession", sa.String(), nullable=True),
    sa.Column("city", sa.String(), nullable=True),
    sa.Column("country", sa.String(), nullable=True),
    sa.Column("age", sa.Integer(), nullable=True),
    sa.Column("photo_url", sa.String(), nullable=True),
    sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.ForeignKeyConstraint(["org_id"], ["organizations.id"]),
    sa.ForeignKeyConstraint(["role_id"], ["roles.id"]),
    sa.PrimaryKeyConstraint("id"),
  )
  op.create_index(op.f("ix_users_email"), "users", ["email"], unique=True)
  op.create_index(op.f("ix_users_firebase_uid"), "users", ["firebase_uid"], unique=True)
  op.create_index(op.f("ix_users_org_id"), "users", ["org_id"], unique=False)
  op.create_table(
    "email_delivery_logs",
    sa.Column("id", sa.Uuid(), nullable=False),
    sa.Column("user_id", sa.Uuid(), nullable=True),
    sa.Column("to_address", sa.String(), nullable=False),
    sa.Column("template_id", sa.String(), nullable=False),
    sa.Column("placeholders", postgresql.JSONB(astext_type=sa.Text()), nullable=False),
    sa.Column("provider", sa.String(), nullable=False),
    sa.Column("provider_message_id", sa.String(), nullable=True),
    sa.Column("provider_request_id", sa.String(), nullable=True),
    sa.Column("provider_response", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("status", sa.String(), nullable=False),
    sa.Column("error_message", sa.Text(), nullable=True),
    sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.ForeignKeyConstraint(["user_id"], ["users.id"]),
    sa.PrimaryKeyConstraint("id"),
  )
  op.create_index(op.f("ix_email_delivery_logs_provider_message_id"), "email_delivery_logs", ["provider_message_id"], unique=False)
  op.create_index(op.f("ix_email_delivery_logs_provider_request_id"), "email_delivery_logs", ["provider_request_id"], unique=False)
  op.create_index(op.f("ix_email_delivery_logs_template_id"), "email_delivery_logs", ["template_id"], unique=False)
  op.create_index(op.f("ix_email_delivery_logs_to_address"), "email_delivery_logs", ["to_address"], unique=False)
  op.create_index(op.f("ix_email_delivery_logs_user_id"), "email_delivery_logs", ["user_id"], unique=False)
  op.create_table(
    "llm_audit_logs",
    sa.Column("id", sa.Integer(), autoincrement=True, nullable=False),
    sa.Column("user_id", sa.Uuid(), nullable=False),
    sa.Column("prompt_summary", sa.Text(), nullable=True),
    sa.Column("model_name", sa.String(), nullable=False),
    sa.Column("tokens_used", sa.Integer(), nullable=True),
    sa.Column("timestamp", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.Column("status", sa.String(), nullable=True),
    sa.ForeignKeyConstraint(["user_id"], ["users.id"]),
    sa.PrimaryKeyConstraint("id"),
  )
  op.create_table(
    "user_tier_overrides",
    sa.Column("id", sa.Integer(), autoincrement=True, nullable=False),
    sa.Column("user_id", sa.UUID(), nullable=False),
    sa.Column("starts_at", sa.DateTime(timezone=True), nullable=False),
    sa.Column("expires_at", sa.DateTime(timezone=True), nullable=False),
    sa.Column("max_file_upload_kb", sa.Integer(), nullable=True),
    sa.Column("file_upload_quota", sa.Integer(), nullable=True),
    sa.Column("image_upload_quota", sa.Integer(), nullable=True),
    sa.Column("gen_sections_quota", sa.Integer(), nullable=True),
    sa.Column("research_quota", sa.Integer(), nullable=True),
    sa.Column("coach_mode_enabled", sa.Boolean(), nullable=True),
    sa.ForeignKeyConstraint(["user_id"], ["users.id"]),
    sa.PrimaryKeyConstraint("id"),
  )
  op.create_index(op.f("ix_user_tier_overrides_user_id"), "user_tier_overrides", ["user_id"], unique=False)
  op.create_table(
    "user_usage_logs",
    sa.Column("id", sa.Integer(), autoincrement=True, nullable=False),
    sa.Column("user_id", sa.UUID(), nullable=False),
    sa.Column("action_type", sa.String(), nullable=False),
    sa.Column("quantity", sa.Integer(), nullable=False),
    sa.Column("metadata_json", postgresql.JSONB(astext_type=sa.Text()), nullable=True),
    sa.Column("created_at", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=False),
    sa.ForeignKeyConstraint(["user_id"], ["users.id"]),
    sa.PrimaryKeyConstraint("id"),
  )
  op.create_index(op.f("ix_user_usage_logs_user_id"), "user_usage_logs", ["user_id"], unique=False)
  op.create_table(
    "user_usage_metrics",
    sa.Column("user_id", sa.UUID(), nullable=False),
    sa.Column("subscription_tier_id", sa.Integer(), nullable=False),
    sa.Column("files_uploaded_count", sa.Integer(), nullable=False),
    sa.Column("images_uploaded_count", sa.Integer(), nullable=False),
    sa.Column("sections_generated_count", sa.Integer(), nullable=False),
    sa.Column("research_usage_count", sa.Integer(), nullable=False),
    sa.Column("last_updated", sa.DateTime(timezone=True), server_default=sa.text("now()"), nullable=True),
    sa.ForeignKeyConstraint(["subscription_tier_id"], ["subscription_tiers.id"]),
    sa.ForeignKeyConstraint(["user_id"], ["users.id"]),
    sa.PrimaryKeyConstraint("user_id"),
  )
  # Seed required reference data so auth/quota code paths never 500 on a fresh DB.
  role_super_admin_id = uuid.UUID("3e56ebfc-1d62-42cb-a920-ab6e916e58bf")
  role_org_admin_id = uuid.UUID("102d6fab-322c-48f8-a8f8-0d9e5eb52aa6")
  role_org_member_id = uuid.UUID("d028adea-31a6-48fb-afd8-777a4cd410b4")
  permission_user_manage_id = uuid.UUID("2fcaeb8d-9824-4506-953a-c5e949db3db8")
  roles_table = sa.table("roles", sa.column("id"), sa.column("name"), sa.column("level"), sa.column("description"))
  permissions_table = sa.table("permissions", sa.column("id"), sa.column("slug"), sa.column("display_name"), sa.column("description"))
  role_permissions_table = sa.table("role_permissions", sa.column("role_id"), sa.column("permission_id"))
  subscription_tiers_table = sa.table(
    "subscription_tiers",
    sa.column("name"),
    sa.column("max_file_upload_kb"),
    sa.column("highest_lesson_depth"),
    sa.column("max_sections_per_lesson"),
    sa.column("file_upload_quota"),
    sa.column("image_upload_quota"),
    sa.column("gen_sections_quota"),
    sa.column("research_quota"),
    sa.column("coach_mode_enabled"),
    sa.column("coach_voice_tier"),
  )
  op.execute(
    insert(roles_table)
    .values(
      [
        {"id": role_super_admin_id, "name": "Super Admin", "level": "GLOBAL", "description": "Global administrator."},
        {"id": role_org_admin_id, "name": "Org Admin", "level": "TENANT", "description": "Organization administrator."},
        {"id": role_org_member_id, "name": "Org Member", "level": "TENANT", "description": "Default role for new users."},
      ]
    )
    .on_conflict_do_nothing(index_elements=["name"])
  )
  op.execute(insert(permissions_table).values([{"id": permission_user_manage_id, "slug": "user:manage", "display_name": "Manage Users", "description": "List users and update roles/statuses."}]).on_conflict_do_nothing(index_elements=["slug"]))
  op.execute(insert(role_permissions_table).values([{"role_id": role_super_admin_id, "permission_id": permission_user_manage_id}]).on_conflict_do_nothing(index_elements=["role_id", "permission_id"]))
  op.execute(
    insert(subscription_tiers_table)
    .values(
      [
        {
          "name": "Free",
          "max_file_upload_kb": 512,
          "highest_lesson_depth": "highlights",
          "max_sections_per_lesson": 2,
          "file_upload_quota": 0,
          "image_upload_quota": 0,
          "gen_sections_quota": 20,
          "research_quota": None,
          "coach_mode_enabled": False,
          "coach_voice_tier": "none",
        },
        {
          "name": "Plus",
          "max_file_upload_kb": 1024,
          "highest_lesson_depth": "detailed",
          "max_sections_per_lesson": 6,
          "file_upload_quota": 5,
          "image_upload_quota": 5,
          "gen_sections_quota": 100,
          "research_quota": None,
          "coach_mode_enabled": True,
          "coach_voice_tier": "device",
        },
        {
          "name": "Pro",
          "max_file_upload_kb": 2048,
          "highest_lesson_depth": "training",
          "max_sections_per_lesson": 10,
          "file_upload_quota": 10,
          "image_upload_quota": 10,
          "gen_sections_quota": 250,
          "research_quota": None,
          "coach_mode_enabled": True,
          "coach_voice_tier": "premium",
        },
      ]
    )
    .on_conflict_do_nothing(index_elements=["name"])
  )
  # ### end Alembic commands ###


def downgrade() -> None:
  """Downgrade schema."""
  # ### commands auto generated by Alembic - please adjust! ###
  op.drop_table("user_usage_metrics")
  op.drop_index(op.f("ix_user_usage_logs_user_id"), table_name="user_usage_logs")
  op.drop_table("user_usage_logs")
  op.drop_index(op.f("ix_user_tier_overrides_user_id"), table_name="user_tier_overrides")
  op.drop_table("user_tier_overrides")
  op.drop_table("llm_audit_logs")
  op.drop_index(op.f("ix_email_delivery_logs_user_id"), table_name="email_delivery_logs")
  op.drop_index(op.f("ix_email_delivery_logs_to_address"), table_name="email_delivery_logs")
  op.drop_index(op.f("ix_email_delivery_logs_template_id"), table_name="email_delivery_logs")
  op.drop_index(op.f("ix_email_delivery_logs_provider_request_id"), table_name="email_delivery_logs")
  op.drop_index(op.f("ix_email_delivery_logs_provider_message_id"), table_name="email_delivery_logs")
  op.drop_table("email_delivery_logs")
  op.drop_index(op.f("ix_users_org_id"), table_name="users")
  op.drop_index(op.f("ix_users_firebase_uid"), table_name="users")
  op.drop_index(op.f("ix_users_email"), table_name="users")
  op.drop_table("users")
  op.drop_table("role_permissions")
  op.drop_table("subscription_tiers")
  op.drop_table("roles")
  op.drop_table("permissions")
  op.drop_table("organizations")
  op.drop_table("llm_call_audit")
  op.drop_table("fenster_widgets")
  op.drop_index(op.f("ix_dylen_lessons_idempotency_key"), table_name="dylen_lessons")
  op.drop_table("dylen_lessons")
  op.drop_index(op.f("ix_dylen_jobs_idempotency_key"), table_name="dylen_jobs")
  op.drop_table("dylen_jobs")
  # ### end Alembic commands ###
