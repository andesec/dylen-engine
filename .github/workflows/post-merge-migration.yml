name: Post-Merge Migration Auto-Fix

on:
  push:
    branches:
      - main
    paths:
      - 'dgs-backend/**'
      - '.github/workflows/post-merge-migration.yml'

jobs:
  auto-fix-migration:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: dgs-backend
    permissions:
      contents: write
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: dgs
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: ".python-version"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Initialize Database
        run: |
          DGS_ENV=development DGS_PG_DSN=postgresql+asyncpg://postgres:password@localhost:5432/dgs uv run python scripts/smart_migrate.py

      - name: Check for Schema Drift
        id: drift_check
        continue-on-error: true
        env:
          DGS_PG_DSN: postgresql+asyncpg://postgres:password@localhost:5432/dgs
        run: |
          uv run alembic check || echo "drift_detected=true" >> $GITHUB_OUTPUT

      - name: Auto-Generate Migration
        if: steps.drift_check.outputs.drift_detected == 'true'
        env:
          DGS_PG_DSN: postgresql+asyncpg://postgres:password@localhost:5432/dgs
        run: |
          # Generate valid migration
          uv run alembic revision --autogenerate -m "auto_sync_main"
          
          # Configure Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add and Commit
          git add migrations/versions/
          git commit -m "chore: auto-generate migration [skip ci]"
          
          # Rebase and Push loop
          MAX_RETRIES=3
          count=0
          until [ $count -ge $MAX_RETRIES ]
          do
             git pull --rebase origin main
             if git push origin main; then
                echo "Push successful"
                exit 0
             fi
             count=$((count+1))
             echo "Push failed, retrying ($count/$MAX_RETRIES)..."
             sleep 2
          done
          echo "Failed to push after $MAX_RETRIES retries"
          exit 1
