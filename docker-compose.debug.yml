services:
  postgres:
    image: postgres:16-alpine
    container_name: dylen-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=dylen
      - POSTGRES_PASSWORD=dylen_password
      - POSTGRES_DB=dylen
    volumes:
      - dylen_pg_data:/var/lib/postgresql/data
    networks:
      - dylen-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U dylen -d dylen" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  postgres-init:
    image: postgres:16-alpine
    container_name: dylen-postgres-init
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./scripts/init-postgres.sh:/init-postgres.sh:ro
      - ./scripts/postgres:/init:ro
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=dylen
      - POSTGRES_PASSWORD=dylen_password
      - POSTGRES_DB=dylen
    networks:
      - dylen-network
    entrypoint: [ "/bin/sh", "/init-postgres.sh" ]
    restart: "no"

  gcs-emulator:
    image: fsouza/fake-gcs-server:latest
    container_name: dylen-gcs-emulator
    command: [ "-scheme", "http", "-port", "4443", "-backend", "filesystem", "-filesystem-root", "/data" ]
    ports:
      - "4443:4443"
    volumes:
      - ./storage_data:/data
    networks:
      - dylen-network

  app:
    build:
      context: .
      target: debug
    image: dylen-engine:debug
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      gcs-emulator:
        condition: service_started
    env_file:
      - .env
    environment:
      - DYLEN_PG_DSN=postgresql://dylen:dylen_password@postgres:5432/dylen
      - DYLEN_AUTO_APPLY_MIGRATIONS=1
      - DYLEN_MIGRATOR_MODE=migrate
      - GOOGLE_APPLICATION_CREDENTIALS=/home/nonroot/.config/gcloud/application_default_credentials.json
      - DYLEN_DUMMY_PLANNER_RESPONSE_PATH=./fixtures/dummy_planner_response.md
      - DYLEN_DUMMY_OUTCOMES_RESPONSE_PATH=./fixtures/dummy_outcomes_response.md
      - DYLEN_DUMMY_SECTION_BUILDER_RESPONSE_PATH=./fixtures/dummy_section_builder_response.md
      - DYLEN_DUMMY_REPAIRER_RESPONSE_PATH=./fixtures/dummy_repairer_response.md
      - GCS_STORAGE_HOST=http://gcs-emulator:4443/storage/v1/
      - DYLEN_ILLUSTRATION_BUCKET=dylen-illustrations
    networks:
      - dylen-network
    ports:
      - "8002:8002"
      - "5678:5678" # debug port
    volumes:
      - ./app:/app/app
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
      - ./scripts:/app/scripts
      - ./logs:/app/logs
      - ~/.config/gcloud/application_default_credentials.json:/home/nonroot/.config/gcloud/application_default_credentials.json:ro
      - ./secrets/service-account.json:/app/service-account.json:ro
      - ./fixtures:/app/fixtures:ro
      - ./secrets/certs:/app/secrets/certs:ro
    command: [ "python", "-Xfrozen_modules=off", "-m", "debugpy", "--listen", "0.0.0.0:5678", "--log-to", "/tmp/debugpy", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8002", "--ssl-keyfile", "/app/secrets/certs/origin.key", "--ssl-certfile", "/app/secrets/certs/origin.crt", "--no-server-header" ]
  # cloudflared:
  #   image: cloudflare/cloudflared:latest
  #   container_name: dylen-cloudflared
  #   restart: unless-stopped
  #   command: tunnel run
  #   environment:
  #     - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
  #   networks:
  #     - dylen-network

networks:
  dylen-network:
    driver: bridge

volumes:
  dylen_pg_data:
