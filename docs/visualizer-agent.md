# Technical Specification: Illustration Agent Integration

## 1. Overview
The Illustration Agent is a secondary service integrated into the lesson generation pipeline. Its role is to consume an `illustration.ai_prompt` generated by the Section Builder and produce a high-quality image using the `gemini-2.5-flash-image` model during the section creation process.

## 2. Data Models (Schema)

### IllustrationConfig (Input/Output)
This object is embedded within a Section's `widget` field and maps to a persistent storage table.

*   **caption:** (String) Descriptive text shown to the user immediately.
*   **keywords:** (Array of Strings) Exactly 4 keywords generated by the Section Builder to guide the visual concept.
*   **illustration.ai_prompt:** (String) Optimized prompt for the image generation model.
*   **image_data:** (String, Nullable) The base64 encoded string of the generated image. Stored in the widget data table.
*   **status:** (String) Enum: `pending`, `processing`, `completed`, `failed`. Tracks the state of the generation in the widget data table.

## 3. Workflow
1.  **Section Generation:** The Section Builder generates the text content and the IllustrationConfig (prompt, keywords, and caption).
2.  **Immediate Execution:** Within the same execution job, the system calls the Gemini API (`gemini-2.5-flash-image`) using the illustration prompt.
3.  **Transformation & Storage:** The raw bytes from the API are converted to a base64 string. All data (text, widget config, and image data) is persisted to the database in a single transaction or sequence.
4.  **UI Delivery:** The frontend receives the complete section data, including the image, and renders the illustration widget immediately.

## 4. Error Handling & Resilience
*   **Exponential Backoff:** Implementation of retries (1s, 2s, 4s, 8s, 16s) for the image generation call within the job to ensure the section is not returned without its visual component.
*   **Graceful Failure:** If image generation fails after all retries, the section is still saved, but the status is set to `failed`. The UI should be designed to handle missing images gracefully (e.g., showing a topic-relevant placeholder).

## 5. Prompt Policy (Required)
The Illustration Agent must enforce the following on every generation prompt:
*   **Vector-first visual style:** Request clean vector-style output (flat shapes, crisp edges, non-photorealistic look).
*   **Tone:** Professional and educational.
*   **Safety/cleanliness:** No logos, no watermarks, and avoid text-heavy poster layouts.

Example prompt suffix:
`Output requirements: vector-style illustration only, clean flat shapes, crisp edges, professional educational tone, factual classroom-safe content, no logos, no watermarks, no photorealism, and avoid text-heavy layouts.`

```python
# Pseudo-code Implementation
async def create_section_with_illustration(topic_data):
    # 1. Generate Section Text & illustration metadata
    section_data = await llm_generate_section(topic_data)
    
    # 2. Extract prompt for illustration
    prompt = section_data.illustration.ai_prompt
    
    # 3. Generate image in the same job
    try:
        image_b64 = await call_imagen_with_backoff(prompt)
        section_data.widget.image_data = image_b64
        section_data.widget.status = "completed"
    except Exception:
        section_data.widget.status = "failed"
    
    # 4. Save to DB and return
    return await save_to_db(section_data)
```
